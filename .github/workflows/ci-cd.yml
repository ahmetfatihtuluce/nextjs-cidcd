# ============================================
# ğŸš€ CI/CD Pipeline - GitHub Actions
# ============================================
# Bu workflow, her push ve pull request'te otomatik olarak Ã§alÄ±ÅŸÄ±r
# ve kodun kalitesini kontrol eder.

name: CI/CD Pipeline

# ============================================
# Tetikleyiciler (Triggers)
# ============================================
on:
  # Main branch'e push yapÄ±ldÄ±ÄŸÄ±nda
  push:
    branches: [main]
  # Main branch'e PR aÃ§Ä±ldÄ±ÄŸÄ±nda
  pull_request:
    branches: [main]

# ============================================
# Jobs (Ä°ÅŸler)
# ============================================
jobs:
  # ==========================================
  # 1ï¸âƒ£ Lint & Format KontrolÃ¼
  # ==========================================
  lint:
    name: ğŸ” Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      # Kodu indir
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Node.js kur
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # ESLint kontrolÃ¼
      - name: ğŸ” Run ESLint
        run: npm run lint

      # Prettier kontrolÃ¼
      - name: ğŸ’… Check Formatting
        run: npm run format:check

  # ==========================================
  # 2ï¸âƒ£ Test
  # ==========================================
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint # Lint baÅŸarÄ±lÄ± olursa Ã§alÄ±ÅŸÄ±r

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # Testleri Ã§alÄ±ÅŸtÄ±r
      - name: ğŸ§ª Run Tests with Coverage
        run: npm run test:coverage

      # Coverage raporunu artifact olarak kaydet
      - name: ğŸ“Š Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # ==========================================
  # 3ï¸âƒ£ Build
  # ==========================================
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: test # Test baÅŸarÄ±lÄ± olursa Ã§alÄ±ÅŸÄ±r

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # UygulamayÄ± derle
      - name: ğŸ—ï¸ Build Next.js App
        run: npm run build

      # Build Ã§Ä±ktÄ±sÄ±nÄ± artifact olarak kaydet
      - name: ğŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: .next/

  # ==========================================
  # 4ï¸âƒ£ E2E Tests
  # ==========================================
  e2e:
    name: ğŸ¯ E2E Tests (Cypress)
    runs-on: ubuntu-latest
    needs: build # Build baÅŸarÄ±lÄ± olursa Ã§alÄ±ÅŸÄ±r

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # Build Next.js app for E2E tests
      - name: ğŸ—ï¸ Build Next.js App
        run: npm run build

      # E2E testlerini Ã§alÄ±ÅŸtÄ±r (production build)
      - name: ğŸ¯ Run E2E Tests
        run: npm run e2e:ci

      # Cypress videolarÄ±nÄ± artifact olarak kaydet (baÅŸarÄ±sÄ±zlÄ±k durumunda)
      - name: ğŸ“¹ Upload Cypress Videos (on failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos/

      # Cypress screenshot'larÄ±nÄ± artifact olarak kaydet (baÅŸarÄ±sÄ±zlÄ±k durumunda)
      - name: ğŸ“¸ Upload Cypress Screenshots (on failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots/

  # ==========================================
  # 5ï¸âƒ£ Docker Build
  # ==========================================
  docker:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: [build, e2e] # Build ve E2E baÅŸarÄ±lÄ± olursa Ã§alÄ±ÅŸÄ±r

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Docker Buildx kurulumu (multi-platform build iÃ§in)
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Docker image'Ä±nÄ± derle (push etmeden)
      - name: ğŸ³ Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: nextjs-cicd:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # 6ï¸âƒ£ Security Scan (GÃ¼venlik TaramasÄ±)
  # ==========================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # npm audit ile gÃ¼venlik taramasÄ±
      - name: ğŸ”’ Run Security Audit
        run: npm audit --audit-level=high
        continue-on-error: true # UyarÄ±lar iÃ§in baÅŸarÄ±sÄ±z olmasÄ±n
